-- Copyright (c) 2020 De Staat der Nederlanden, Ministerie van   Volksgezondheid, Welzijn en Sport. 
-- Licensed under the EUROPEAN UNION PUBLIC LICENCE v. 1.2 - see https://github.com/minvws/nl-contact-tracing-app-coordinationfor more information.

CREATE OR ALTER PROCEDURE [dbo].[SP_RESULTS_PER_REGION_ARCHIVE_DEST]
AS
BEGIN

    WITH SELECTED_TO_BE_ARCHIVED AS (
    SELECT 
       [DATE_OF_REPORT]
      ,[DATE_OF_REPORT_UNIX]
      ,[VRCODE]
      ,[TOTAL_REPORTED_INCREASE_PER_REGION]
      ,[INFECTED_TOTAL_COUNTS_PER_REGION]
      ,[HOSPITAL_TOTAL_COUNTS_PER_REGION]
      ,[INFECTED_INCREASE_PER_REGION]
      ,[HOSPITAL_INCREASE_PER_REGION]
      ,[INFECTED_MOVING_AVG_PER_REGION]
      ,[HOSPITAL_MOVING_AVG_PER_REGION]
      ,[DATE_LAST_INSERTED]
      ,[DECEASED]
    FROM [VWSDEST].[RESULTS_PER_REGION]
    WHERE DATE_LAST_INSERTED IN (
        SELECT SubQueryC.DATE_LAST_INSERTED
        FROM(
        SELECT SubQueryB.DATE_LAST_INSERTED, SubQueryB.RANKING 
        FROM (
            SELECT SubQueryA.DATE_LAST_INSERTED, rank() OVER(ORDER BY DATE_LAST_INSERTED DESC) RANKING
            FROM (
            SELECT DISTINCT DATE_LAST_INSERTED
            FROM [VWSDEST].[RESULTS_PER_REGION]) SubQueryA
        ) SubQueryB
        WHERE SubQueryB.RANKING > 2)SubQueryC)) 

    INSERT INTO VWSARCHIVE.RESULTS_PER_REGION
        ([DATE_OF_REPORT]
      ,[DATE_OF_REPORT_UNIX]
      ,[VRCODE]
      ,[TOTAL_REPORTED_INCREASE_PER_REGION]
      ,[INFECTED_TOTAL_COUNTS_PER_REGION]
      ,[HOSPITAL_TOTAL_COUNTS_PER_REGION]
      ,[INFECTED_INCREASE_PER_REGION]
      ,[HOSPITAL_INCREASE_PER_REGION]
      ,[INFECTED_MOVING_AVG_PER_REGION]
      ,[HOSPITAL_MOVING_AVG_PER_REGION]
      ,[DATE_LAST_INSERTED]
      ,[DECEASED]
      )
     SELECT
        [DATE_OF_REPORT]
      ,[DATE_OF_REPORT_UNIX]
      ,[VRCODE]
      ,[TOTAL_REPORTED_INCREASE_PER_REGION]
      ,[INFECTED_TOTAL_COUNTS_PER_REGION]
      ,[HOSPITAL_TOTAL_COUNTS_PER_REGION]
      ,[INFECTED_INCREASE_PER_REGION]
      ,[HOSPITAL_INCREASE_PER_REGION]
      ,[INFECTED_MOVING_AVG_PER_REGION]
      ,[HOSPITAL_MOVING_AVG_PER_REGION]
      ,[DATE_LAST_INSERTED]
      ,[DECEASED]
    FROM SELECTED_TO_BE_ARCHIVED;

    DELETE FROM VWSDEST.RESULTS_PER_REGION
    WHERE DATE_LAST_INSERTED IN (
        SELECT SubQueryC.DATE_LAST_INSERTED
        FROM(
            SELECT SubQueryB.DATE_LAST_INSERTED, SubQueryB.RANKING
            FROM (
                SELECT SubQueryA.DATE_LAST_INSERTED, rank() OVER(ORDER BY DATE_LAST_INSERTED DESC) RANKING
                FROM (
                SELECT DISTINCT DATE_LAST_INSERTED
                FROM VWSDEST.RESULTS_PER_REGION) SubQueryA
        ) SubQueryB
        WHERE SubQueryB.RANKING > 2)SubQueryC);
END;